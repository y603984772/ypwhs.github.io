<!DOCTYPE html>













<html class="theme-next pisces" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




















  
  
  <link rel="stylesheet" href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5">







<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=6.7.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/xkl.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/xkl.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/xlk.png?v=6.7.0">


  <link rel="mask-icon" href="/images/xkl.svg?v=6.7.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.7.0',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="本文会通过 Keras 搭建一个深度卷积神经网络来识别一张图片是猫还是狗，在验证集上的准确率可以达到99.6%，建议使用显卡来运行该项目。本项目使用的 Keras 版本是1.2.2。 猫狗大战数据集来自 kaggle 上的一个竞赛：Dogs vs. Cats，训练集有25000张，猫狗各占一半。测试集12500张，没有标定是猫还是狗。 1234567891011121314151617181920">
<meta property="og:type" content="article">
<meta property="og:title" content="手把手教你如何在Kaggle猫狗大战冲到Top2%">
<meta property="og:url" content="https://ypw.io/dogs-vs-cats-2/index.html">
<meta property="og:site_name" content="杨培文">
<meta property="og:description" content="本文会通过 Keras 搭建一个深度卷积神经网络来识别一张图片是猫还是狗，在验证集上的准确率可以达到99.6%，建议使用显卡来运行该项目。本项目使用的 Keras 版本是1.2.2。 猫狗大战数据集来自 kaggle 上的一个竞赛：Dogs vs. Cats，训练集有25000张，猫狗各占一半。测试集12500张，没有标定是猫还是狗。 1234567891011121314151617181920">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://ypw.io/dogs-vs-cats-2/dataset.png">
<meta property="og:image" content="https://ypw.io/dogs-vs-cats-2/model.png">
<meta property="og:image" content="https://ypw.io/dogs-vs-cats-2/logloss.png">
<meta property="og:updated_time" content="2017-03-24T05:49:16.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="手把手教你如何在Kaggle猫狗大战冲到Top2%">
<meta name="twitter:description" content="本文会通过 Keras 搭建一个深度卷积神经网络来识别一张图片是猫还是狗，在验证集上的准确率可以达到99.6%，建议使用显卡来运行该项目。本项目使用的 Keras 版本是1.2.2。 猫狗大战数据集来自 kaggle 上的一个竞赛：Dogs vs. Cats，训练集有25000张，猫狗各占一半。测试集12500张，没有标定是猫还是狗。 1234567891011121314151617181920">
<meta name="twitter:image" content="https://ypw.io/dogs-vs-cats-2/dataset.png">






  <link rel="canonical" href="https://ypw.io/dogs-vs-cats-2/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>手把手教你如何在Kaggle猫狗大战冲到Top2% | 杨培文</title>
  




  <script async src="//www.googletagmanager.com/gtag/js?id=UA-111276663-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-111276663-1');
  </script>









  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">杨培文</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">Yang Peiwen</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ypw.io/dogs-vs-cats-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="杨培文">
      <meta itemprop="description" content="杨培文的 blog">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="杨培文">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">手把手教你如何在Kaggle猫狗大战冲到Top2%

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-03-18 21:41:55" itemprop="dateCreated datePublished" datetime="2017-03-18T21:41:55+08:00">2017-03-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2017-03-24 13:49:16" itemprop="dateModified" datetime="2017-03-24T13:49:16+08:00">2017-03-24</time>
              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>本文会通过 Keras 搭建一个深度卷积神经网络来识别一张图片是猫还是狗，在验证集上的准确率可以达到99.6%，建议使用显卡来运行该项目。本项目使用的 Keras 版本是1.2.2。</p>
<h1 id="猫狗大战"><a href="#猫狗大战" class="headerlink" title="猫狗大战"></a>猫狗大战</h1><p>数据集来自 kaggle 上的一个竞赛：<a href="https://www.kaggle.com/c/dogs-vs-cats-redux-kernels-edition" target="_blank" rel="noopener">Dogs vs. Cats</a>，训练集有25000张，猫狗各占一半。测试集12500张，没有标定是猫还是狗。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">➜  猫狗大战 ls train | head</span><br><span class="line">cat.0.jpg</span><br><span class="line">cat.1.jpg</span><br><span class="line">cat.10.jpg</span><br><span class="line">cat.100.jpg</span><br><span class="line">cat.1000.jpg</span><br><span class="line">cat.10000.jpg</span><br><span class="line">cat.10001.jpg</span><br><span class="line">cat.10002.jpg</span><br><span class="line">cat.10003.jpg</span><br><span class="line">cat.10004.jpg</span><br><span class="line">➜  猫狗大战 ls test | head</span><br><span class="line">1.jpg</span><br><span class="line">10.jpg</span><br><span class="line">100.jpg</span><br><span class="line">1000.jpg</span><br><span class="line">10000.jpg</span><br><span class="line">10001.jpg</span><br><span class="line">10002.jpg</span><br><span class="line">10003.jpg</span><br><span class="line">10004.jpg</span><br><span class="line">10005.jpg</span><br></pre></td></tr></table></figure>
<p>下面是训练集的一部分例子：</p>
<img src="/dogs-vs-cats-2/dataset.png">
<a id="more"></a>
<h1 id="数据预处理"><a href="#数据预处理" class="headerlink" title="数据预处理"></a>数据预处理</h1><p>由于我们的数据集的文件名是以<code>type.num.jpg</code>这样的方式命名的，比如<code>cat.0.jpg</code>，但是使用 Keras 的 ImageDataGenerator 需要将不同种类的图片分在不同的文件夹中，因此我们需要对数据集进行预处理。这里我们采取的思路是创建符号链接(symbol link)，这样的好处是不用复制一遍图片，占用不必要的空间。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"></span><br><span class="line">train_filenames = os.listdir(<span class="string">'train'</span>)</span><br><span class="line">train_cat = filter(<span class="keyword">lambda</span> x:x[:<span class="number">3</span>] == <span class="string">'cat'</span>, train_filenames)</span><br><span class="line">train_dog = filter(<span class="keyword">lambda</span> x:x[:<span class="number">3</span>] == <span class="string">'dog'</span>, train_filenames)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rmrf_mkdir</span><span class="params">(dirname)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> os.path.exists(dirname):</span><br><span class="line">        shutil.rmtree(dirname)</span><br><span class="line">    os.mkdir(dirname)</span><br><span class="line"></span><br><span class="line">rmrf_mkdir(<span class="string">'train2'</span>)</span><br><span class="line">os.mkdir(<span class="string">'train2/cat'</span>)</span><br><span class="line">os.mkdir(<span class="string">'train2/dog'</span>)</span><br><span class="line"></span><br><span class="line">rmrf_mkdir(<span class="string">'test2'</span>)</span><br><span class="line">os.symlink(<span class="string">'../test/'</span>, <span class="string">'test2/test'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> filename <span class="keyword">in</span> train_cat:</span><br><span class="line">    os.symlink(<span class="string">'../../train/'</span>+filename, <span class="string">'train2/cat/'</span>+filename)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> filename <span class="keyword">in</span> train_dog:</span><br><span class="line">    os.symlink(<span class="string">'../../train/'</span>+filename, <span class="string">'train2/dog/'</span>+filename)</span><br></pre></td></tr></table></figure>
<p>我们可以从下面看到文件夹的结构，train2里面有两个文件夹，分别是猫和狗，每个文件夹里是12500张图。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">├── test [12500 images]</span><br><span class="line">├── test.zip</span><br><span class="line">├── test2</span><br><span class="line">│   └── test -&gt; ../test/</span><br><span class="line">├── train [25000 images]</span><br><span class="line">├── train.zip</span><br><span class="line">└── train2</span><br><span class="line">    ├── cat [12500 images]</span><br><span class="line">    └── dog [12500 images]</span><br></pre></td></tr></table></figure>
<h1 id="导出特征向量"><a href="#导出特征向量" class="headerlink" title="导出特征向量"></a>导出特征向量</h1><p>对于这个题目来说，使用预训练的网络是最好不过的了，经过前期的测试，我们测试了 ResNet50 等不同的网络，但是排名都不高，现在看来只有一两百名的样子，所以我们需要提高我们的模型表现。那么一种有效的方法是综合各个不同的模型，从而得到不错的效果，兼听则明。如果是直接在一个巨大的网络后面加我们的全连接，那么训练10代就需要跑十次巨大的网络，而且我们的卷积层都是不可训练的，那么这个计算就是浪费的。所以我们可以将多个不同的网络输出的特征向量先保存下来，以便后续的训练，这样做的好处是我们一旦保存了特征向量，即使是在普通笔记本上也能轻松训练。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> keras.models <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> keras.layers <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> keras.applications <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> keras.preprocessing.image <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> h5py</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_gap</span><span class="params">(MODEL, image_size, lambda_func=None)</span>:</span></span><br><span class="line">    width = image_size[<span class="number">0</span>]</span><br><span class="line">    height = image_size[<span class="number">1</span>]</span><br><span class="line">    input_tensor = Input((height, width, <span class="number">3</span>))</span><br><span class="line">    x = input_tensor</span><br><span class="line">    <span class="keyword">if</span> lambda_func:</span><br><span class="line">        x = Lambda(lambda_func)(x)</span><br><span class="line">    </span><br><span class="line">    base_model = MODEL(input_tensor=x, weights=<span class="string">'imagenet'</span>, include_top=<span class="keyword">False</span>)</span><br><span class="line">    model = Model(base_model.input, GlobalAveragePooling2D()(base_model.output))</span><br><span class="line"></span><br><span class="line">    gen = ImageDataGenerator()</span><br><span class="line">    train_generator = gen.flow_from_directory(<span class="string">"train2"</span>, image_size, shuffle=<span class="keyword">False</span>, </span><br><span class="line">                                              batch_size=<span class="number">16</span>)</span><br><span class="line">    test_generator = gen.flow_from_directory(<span class="string">"test2"</span>, image_size, shuffle=<span class="keyword">False</span>, </span><br><span class="line">                                             batch_size=<span class="number">16</span>, class_mode=<span class="keyword">None</span>)</span><br><span class="line"></span><br><span class="line">    train = model.predict_generator(train_generator, train_generator.nb_sample)</span><br><span class="line">    test = model.predict_generator(test_generator, test_generator.nb_sample)</span><br><span class="line">    <span class="keyword">with</span> h5py.File(<span class="string">"gap_%s.h5"</span>%MODEL.func_name) <span class="keyword">as</span> h:</span><br><span class="line">        h.create_dataset(<span class="string">"train"</span>, data=train)</span><br><span class="line">        h.create_dataset(<span class="string">"test"</span>, data=test)</span><br><span class="line">        h.create_dataset(<span class="string">"label"</span>, data=train_generator.classes)</span><br><span class="line"></span><br><span class="line">write_gap(ResNet50, (<span class="number">224</span>, <span class="number">224</span>))</span><br><span class="line">write_gap(InceptionV3, (<span class="number">299</span>, <span class="number">299</span>), inception_v3.preprocess_input)</span><br><span class="line">write_gap(Xception, (<span class="number">299</span>, <span class="number">299</span>), xception.preprocess_input)</span><br></pre></td></tr></table></figure>
<p>为了复用代码，我觉得写一个函数是非常有必要的，那么我们的函数就需要输入模型，输入图片的大小，以及<a href="https://github.com/fchollet/keras/blob/master/keras/applications/inception_v3.py#L389-L393" target="_blank" rel="noopener">预处理函数</a>，因为 Xception 和 Inception V3 都需要将数据限定在 <code>(-1, 1)</code> 的范围内，然后我们利用 <code>GlobalAveragePooling2D</code> 将卷积层输出的每个激活图直接求平均值，不然输出的文件会非常大，且容易过拟合。然后我们定义了两个 generator，利用 <code>model.predict_generator</code> 函数来导出特征向量，最后我们选择了 ResNet50, Xception, Inception V3 这三个模型（如果有兴趣也可以导出 VGG 的特征向量）。每个模型导出的时间都挺长的，在 aws p2.xlarge 上大概需要用<strong>十分钟到二十分钟</strong>。 这三个模型都是在 <a href="http://www.image-net.org/" target="_blank" rel="noopener">ImageNet</a> 上面预训练过的，所以每一个模型都可以说是身经百战，通过这三个老司机导出的特征向量，可以高度概括一张图片有哪些内容。</p>
<p>最后导出的 h5 文件包括三个 numpy 数组：</p>
<ul>
<li>train (25000, 2048)</li>
<li>test (12500, 2048)</li>
<li>label (25000,)</li>
</ul>
<p>如果你不想自己计算特征向量，可以直接在这里下载导出的文件：<a href="https://github.com/ypwhs/dogs_vs_cats/releases/tag/gap" target="_blank" rel="noopener">GitHub releases</a> <a href="https://pan.baidu.com/s/1pK7psxX#list/path=%2Fdataset%2FDogs%20vs%20Cats" target="_blank" rel="noopener">百度云</a></p>
<p>参考资料：</p>
<ul>
<li><a href="https://arxiv.org/abs/1512.03385" target="_blank" rel="noopener">ResNet</a> 15.12</li>
<li><a href="https://arxiv.org/abs/1512.00567" target="_blank" rel="noopener">Inception v3</a> 15.12</li>
<li><a href="https://arxiv.org/abs/1610.02357" target="_blank" rel="noopener">Xception</a> 16.10</li>
</ul>
<h1 id="载入特征向量"><a href="#载入特征向量" class="headerlink" title="载入特征向量"></a>载入特征向量</h1><p>经过上面的代码以后，我们获得了三个特征向量文件，分别是：</p>
<ul>
<li>gap_ResNet50.h5</li>
<li>gap_InceptionV3.h5</li>
<li>gap_Xception.h5</li>
</ul>
<p>我们需要载入这些特征向量，并且将它们合成一条特征向量，然后记得把 X 和 y 打乱，不然之后我们设置<code>validation_split</code>的时候会出问题。这里设置了 numpy 的随机数种子为2017，这样可以确保每个人跑这个代码，输出都能是一样的结果。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> h5py</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> sklearn.utils <span class="keyword">import</span> shuffle</span><br><span class="line">np.random.seed(<span class="number">2017</span>)</span><br><span class="line"></span><br><span class="line">X_train = []</span><br><span class="line">X_test = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> filename <span class="keyword">in</span> [<span class="string">"gap_ResNet50.h5"</span>, <span class="string">"gap_Xception.h5"</span>, <span class="string">"gap_InceptionV3.h5"</span>]:</span><br><span class="line">    <span class="keyword">with</span> h5py.File(filename, <span class="string">'r'</span>) <span class="keyword">as</span> h:</span><br><span class="line">        X_train.append(np.array(h[<span class="string">'train'</span>]))</span><br><span class="line">        X_test.append(np.array(h[<span class="string">'test'</span>]))</span><br><span class="line">        y_train = np.array(h[<span class="string">'label'</span>])</span><br><span class="line"></span><br><span class="line">X_train = np.concatenate(X_train, axis=<span class="number">1</span>)</span><br><span class="line">X_test = np.concatenate(X_test, axis=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">X_train, y_train = shuffle(X_train, y_train)</span><br></pre></td></tr></table></figure>
<h1 id="构建模型"><a href="#构建模型" class="headerlink" title="构建模型"></a>构建模型</h1><p>模型的构建很简单，直接 dropout 然后分类就好了。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> keras.models <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> keras.layers <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">np.random.seed(<span class="number">2017</span>)</span><br><span class="line"></span><br><span class="line">input_tensor = Input(X_train.shape[<span class="number">1</span>:])</span><br><span class="line">x = Dropout(<span class="number">0.5</span>)(input_tensor)</span><br><span class="line">x = Dense(<span class="number">1</span>, activation=<span class="string">'sigmoid'</span>)(x)</span><br><span class="line">model = Model(input_tensor, x)</span><br><span class="line"></span><br><span class="line">model.compile(optimizer=<span class="string">'adadelta'</span>,</span><br><span class="line">              loss=<span class="string">'binary_crossentropy'</span>,</span><br><span class="line">              metrics=[<span class="string">'accuracy'</span>])</span><br></pre></td></tr></table></figure>
<p>我们还可以对模型进行可视化：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">digraph G&#123;</span><br><span class="line">    node [shape=record]</span><br><span class="line">    a[label=&quot;ResNet50|&#123;input:|output:&#125;|&#123;(224, 224, 3)|(2048)&#125;&quot;]</span><br><span class="line">    b[label=&quot;InceptionV3|&#123;input:|output:&#125;|&#123;(299, 299, 3)|(2048)&#125;&quot;]</span><br><span class="line">    c[label=&quot;Xception|&#123;input:|output:&#125;|&#123;(299, 299, 3)|(2048)&#125;&quot;]</span><br><span class="line">    Merge[label=&quot;Merge|&#123;input:|output:&#125;|&#123;(3, 2048)|(6144)&#125;&quot;]</span><br><span class="line">    Dropout[label=&quot;Dropout|Rate:|0.5&quot;]</span><br><span class="line">    Output[label=&quot;Output|&#123;input:|output:&#125;|&#123;(6144)|(1)&#125;&quot;]</span><br><span class="line">    Image -&gt; a -&gt; Merge</span><br><span class="line">    Image -&gt; b -&gt; Merge</span><br><span class="line">    Image -&gt; c -&gt; Merge</span><br><span class="line">    Merge -&gt; Dropout -&gt; Output</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img src="/dogs-vs-cats-2/model.png">
<h1 id="训练模型"><a href="#训练模型" class="headerlink" title="训练模型"></a>训练模型</h1><p>模型构件好了以后，我们就可以进行训练了，这里我们设置验证集大小为 20% ，也就是说训练集是20000张图，验证集是5000张图。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">model.fit(X_train, y_train, batch_size=<span class="number">128</span>, nb_epoch=<span class="number">8</span>, validation_split=<span class="number">0.2</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Train on 20000 samples, validate on 5000 samples</span><br><span class="line">Epoch 1/8</span><br><span class="line">20000/20000 [==============================] - 1s - loss: 0.1193 - acc: 0.9591 - val_loss: 0.0283 - val_acc: 0.9936</span><br><span class="line">Epoch 2/8</span><br><span class="line">20000/20000 [==============================] - 0s - loss: 0.0319 - acc: 0.9898 - val_loss: 0.0181 - val_acc: 0.9952</span><br><span class="line">Epoch 3/8</span><br><span class="line">20000/20000 [==============================] - 0s - loss: 0.0252 - acc: 0.9916 - val_loss: 0.0172 - val_acc: 0.9934</span><br><span class="line">Epoch 4/8</span><br><span class="line">20000/20000 [==============================] - 0s - loss: 0.0214 - acc: 0.9936 - val_loss: 0.0140 - val_acc: 0.9956</span><br><span class="line">Epoch 5/8</span><br><span class="line">20000/20000 [==============================] - 0s - loss: 0.0200 - acc: 0.9926 - val_loss: 0.0139 - val_acc: 0.9954</span><br><span class="line">Epoch 6/8</span><br><span class="line">20000/20000 [==============================] - 0s - loss: 0.0189 - acc: 0.9933 - val_loss: 0.0129 - val_acc: 0.9956</span><br><span class="line">Epoch 7/8</span><br><span class="line">20000/20000 [==============================] - 0s - loss: 0.0170 - acc: 0.9946 - val_loss: 0.0123 - val_acc: 0.9960</span><br><span class="line">Epoch 8/8</span><br><span class="line">20000/20000 [==============================] - 0s - loss: 0.0163 - acc: 0.9945 - val_loss: 0.0119 - val_acc: 0.9958</span><br><span class="line">Out[4]:</span><br></pre></td></tr></table></figure>
<p>我们可以看到，训练的过程很快，十秒以内就能训练完，准确率也很高，在验证集上最高达到了99.6%的准确率，这相当于一千张图只错了4张，可以说比我还厉害。</p>
<h1 id="预测测试集"><a href="#预测测试集" class="headerlink" title="预测测试集"></a>预测测试集</h1><p>模型训练好以后，我们就可以对测试集进行预测，然后提交到 kaggle 上看看最终成绩了。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">y_pred = model.predict(X_test, verbose=<span class="number">1</span>)</span><br><span class="line">y_pred = y_pred.clip(min=<span class="number">0.005</span>, max=<span class="number">0.995</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> keras.preprocessing.image <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">df = pd.read_csv(<span class="string">"sample_submission.csv"</span>)</span><br><span class="line"></span><br><span class="line">gen = ImageDataGenerator()</span><br><span class="line">test_generator = gen.flow_from_directory(<span class="string">"test2"</span>, (<span class="number">224</span>, <span class="number">224</span>), shuffle=<span class="keyword">False</span>, </span><br><span class="line">                                         batch_size=<span class="number">16</span>, class_mode=<span class="keyword">None</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i, fname <span class="keyword">in</span> enumerate(test_generator.filenames):</span><br><span class="line">    index = int(fname[fname.rfind(<span class="string">'/'</span>)+<span class="number">1</span>:fname.rfind(<span class="string">'.'</span>)])</span><br><span class="line">    df.set_value(index<span class="number">-1</span>, <span class="string">'label'</span>, y_pred[i])</span><br><span class="line"></span><br><span class="line">df.to_csv(<span class="string">'pred.csv'</span>, index=<span class="keyword">None</span>)</span><br><span class="line">df.head(<span class="number">10</span>)</span><br></pre></td></tr></table></figure>
<p>预测这里我们用到了一个小技巧，我们将每个预测值限制到了 [0.005, 0.995] 个区间内，这个原因很简单，kaggle 官方的评估标准是 <a href="https://www.kaggle.com/c/dogs-vs-cats-redux-kernels-edition/details/evaluation" target="_blank" rel="noopener">LogLoss</a>，对于预测正确的样本，0.995 和 1 相差无几，但是对于预测错误的样本，0 和 0.005 的差距非常大，是 15 和 2 的差别。参考 <a href="https://www.kaggle.com/wiki/LogLoss" target="_blank" rel="noopener">LogLoss 如何处理无穷大问题</a>，下面的表达式就是二分类问题的 LogLoss 定义。</p>
<p>$$\textrm{LogLoss} = - \frac{1}{n} \sum_{i=1}^n \left[ y_i \log(\hat{y}_i) + (1 - y_i) \log(1 - \hat{y}_i)\right]$$</p>
<img src="/dogs-vs-cats-2/logloss.png">
<p>还有一个值得一提的地方就是测试集的文件名不是按 1, 2, 3 这样排的，而是按下面的顺序排列的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[&apos;test/1.jpg&apos;,</span><br><span class="line"> &apos;test/10.jpg&apos;,</span><br><span class="line"> &apos;test/100.jpg&apos;,</span><br><span class="line"> &apos;test/1000.jpg&apos;,</span><br><span class="line"> &apos;test/10000.jpg&apos;,</span><br><span class="line"> &apos;test/10001.jpg&apos;,</span><br><span class="line"> &apos;test/10002.jpg&apos;,</span><br><span class="line"> &apos;test/10003.jpg&apos;,</span><br><span class="line"> ......</span><br></pre></td></tr></table></figure>
<p>因此我们需要对每个文件名进行处理，然后赋值到 df 里，最后导出为 csv 文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">	id	label</span><br><span class="line">0	1	0.995</span><br><span class="line">1	2	0.995</span><br><span class="line">2	3	0.995</span><br><span class="line">3	4	0.995</span><br><span class="line">4	5	0.005</span><br><span class="line">5	6	0.005</span><br><span class="line">6	7	0.005</span><br><span class="line">7	8	0.005</span><br><span class="line">8	9	0.005</span><br><span class="line">9	10	0.005</span><br></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>我们可以从上图中看到，模型对于前十个样本都给出了很肯定的预测，提交到 kaggle 以后，得分也是很棒，0.04141，在全球排名中可以排到20/1314。我们如果要继续优化模型表现，可以使用更棒的预训练模型来导出特征向量，或者对预训练模型进行微调（fine-tune），或者进行数据增强（data augmentation）等。</p>
<p>参考链接：<a href="http://keras-cn.readthedocs.io/en/latest/blog/image_classification_using_very_little_data/" target="_blank" rel="noopener">面向小数据集构建图像分类模型</a></p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/captcha/" rel="next" title="使用 Keras 来破解 captcha 验证码">
                <i class="fa fa-chevron-left"></i> 使用 Keras 来破解 captcha 验证码
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/buy-iphone-x/" rel="prev" title="如何抢到 iPhone X 深空灰色 256G">
                如何抢到 iPhone X 深空灰色 256G <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="杨培文">
            
              <p class="site-author-name" itemprop="name">杨培文</p>
              <p class="site-description motion-element" itemprop="description">杨培文的 blog</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">68</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">19</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/ypwhs" title="GitHub &rarr; https://github.com/ypwhs" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://weibo.com/ypwhs" title="Weibo &rarr; https://weibo.com/ypwhs" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i>Weibo</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="http://www.zhihu.com/people/yangpw" title="知乎 &rarr; http://www.zhihu.com/people/yangpw" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i>知乎</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://www.linkedin.com/in/ypwhs" title="Linkedin &rarr; https://www.linkedin.com/in/ypwhs" rel="noopener" target="_blank"><i class="fa fa-fw fa-linkedin"></i>Linkedin</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#猫狗大战"><span class="nav-number">1.</span> <span class="nav-text">猫狗大战</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#数据预处理"><span class="nav-number">2.</span> <span class="nav-text">数据预处理</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#导出特征向量"><span class="nav-number">3.</span> <span class="nav-text">导出特征向量</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#载入特征向量"><span class="nav-number">4.</span> <span class="nav-text">载入特征向量</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#构建模型"><span class="nav-number">5.</span> <span class="nav-text">构建模型</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#训练模型"><span class="nav-number">6.</span> <span class="nav-text">训练模型</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#预测测试集"><span class="nav-number">7.</span> <span class="nav-text">预测测试集</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">8.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">杨培文</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v6.7.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>












  















  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script src="/js/src/utils.js?v=6.7.0"></script>

  <script src="/js/src/motion.js?v=6.7.0"></script>



  
  


  <script src="/js/src/affix.js?v=6.7.0"></script>

  <script src="/js/src/schemes/pisces.js?v=6.7.0"></script>



  
  <script src="/js/src/scrollspy.js?v=6.7.0"></script>
<script src="/js/src/post-details.js?v=6.7.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.7.0"></script>



  


  


  





  

  

  

  

  
  

  
  

  


  

  

  

  

  

  

  

  

</body>
</html>
